name: Firmware Build

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  lint_and_unit_test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository and submodules
      uses: actions/checkout@v3
      with:
        fetch-depth: 10
        submodules: 'recursive'
    - name: Setup Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.x
        architecture: 'x64'
    - name: Check code formatting
      shell: bash
      run: |
        git fetch --no-recurse-submodules
        echo "Checking code format"
        sudo apt install clang-format
        if [[ $GITHUB_EVENT_NAME == 'push' ]]; then
            BASE=${{ github.event.before }}
        else
            BASE=origin/$GITHUB_BASE_REF
        fi
        REPO_ROOT=`pwd` ./scripts/lint/ci_check_clang_format.sh --merge-base $BASE
    - name: Run unit tests
      shell: bash
      run: |
        cd test
        ./test.sh
